<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - BMB Content Server</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 min-h-screen">
  <!-- Navigation -->
  <nav class="bg-slate-900 text-white shadow-lg">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">
        <a href="/" class="text-xl font-bold tracking-tight">BMB Content Server</a>
        <div class="flex items-center gap-6">
          <a href="/gallery" class="text-slate-300 hover:text-white transition-colors">Gallery</a>
          <a href="/posts" class="text-slate-300 hover:text-white transition-colors">Posts</a>
          <a href="/admin" class="text-white font-medium">Admin</a>
          <a href="/admin/logout" class="bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded-lg text-sm transition-colors">Logout</a>
        </div>
      </div>
    </div>
  </nav>

  <!-- Toast Notification -->
  <div id="toast" class="fixed top-4 right-4 z-50 transform translate-x-[120%] transition-transform duration-300">
    <div id="toastContent" class="px-6 py-4 rounded-xl shadow-lg flex items-center gap-3 min-w-[300px]">
      <span id="toastIcon" class="text-xl"></span>
      <span id="toastMessage" class="font-medium text-sm"></span>
    </div>
  </div>

  <!-- Main Content -->
  <main class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <h1 class="text-3xl font-bold text-slate-900 mb-8">Upload Content</h1>

    <!-- Type Selector -->
    <div class="bg-white rounded-2xl shadow-sm p-6 mb-8">
      <label class="block text-sm font-medium text-slate-700 mb-4">Upload Type</label>
      <div class="flex gap-4">
        <label class="flex-1 cursor-pointer" id="thumbRadioLabel">
          <input type="radio" name="uploadType" value="thumbnail" checked class="hidden" id="thumbRadio">
          <div class="border-2 rounded-xl p-4 text-center transition-all border-blue-600 bg-blue-50" id="thumbCard">
            <svg class="w-8 h-8 mx-auto mb-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
            <span class="font-medium text-slate-700">Thumbnail</span>
          </div>
        </label>
        <label class="flex-1 cursor-pointer" id="postRadioLabel">
          <input type="radio" name="uploadType" value="post" class="hidden" id="postRadio">
          <div class="border-2 rounded-xl p-4 text-center transition-all border-slate-200" id="postCard">
            <svg class="w-8 h-8 mx-auto mb-2 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"/>
            </svg>
            <span class="font-medium text-slate-700">Blog Post</span>
          </div>
        </label>
      </div>
    </div>

    <!-- Thumbnail Upload Form -->
    <div id="thumbnailForm" class="bg-white rounded-2xl shadow-sm p-6">
      <h2 class="text-xl font-semibold text-slate-900 mb-6">Upload Thumbnail</h2>
      <form id="thumbForm" class="space-y-6">
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-2">Image File</label>
          <div id="thumbDropZone" class="border-2 border-dashed border-slate-300 rounded-xl p-8 text-center hover:border-blue-400 transition-colors cursor-pointer">
            <svg class="w-12 h-12 mx-auto text-slate-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
            </svg>
            <p class="text-slate-600 mb-2">Click or drag & drop to upload</p>
            <p class="text-sm text-slate-400">JPG, PNG, or WebP (max 10MB)</p>
            <input type="file" id="thumbFile" accept=".jpg,.jpeg,.png,.webp" class="hidden">
          </div>
          <div id="thumbPreview" class="hidden mt-4 text-center">
            <img id="thumbPreviewImg" class="max-h-48 rounded-lg mx-auto shadow-sm" alt="Preview">
            <p id="thumbPreviewName" class="text-sm text-slate-500 mt-2"></p>
            <button type="button" id="thumbClear" class="text-sm text-red-500 hover:text-red-600 mt-1">Remove</button>
          </div>
        </div>
        <button type="submit" id="thumbSubmit" class="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-slate-300 disabled:cursor-not-allowed text-white font-medium py-3 px-4 rounded-lg transition-colors flex items-center justify-center">
          <span id="thumbBtnText">Upload Thumbnail</span>
          <svg id="thumbSpinner" class="hidden animate-spin ml-2 h-5 w-5" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
        </button>
      </form>
    </div>

    <!-- Blog Post Upload Form -->
    <div id="postForm" class="bg-white rounded-2xl shadow-sm p-6 hidden">
      <h2 class="text-xl font-semibold text-slate-900 mb-6">Upload Blog Post</h2>
      <form id="blogForm" class="space-y-6">
        <div>
          <label for="postTitle" class="block text-sm font-medium text-slate-700 mb-2">Post Title</label>
          <input type="text" id="postTitle" required class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all" placeholder="Enter post title">
          <p id="slugPreview" class="text-sm text-slate-400 mt-1"></p>
        </div>

        <div>
          <label class="block text-sm font-medium text-slate-700 mb-2">HTML Content File</label>
          <div id="htmlDropZone" class="border-2 border-dashed border-slate-300 rounded-xl p-6 text-center hover:border-blue-400 transition-colors cursor-pointer">
            <svg class="w-10 h-10 mx-auto text-slate-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            <p class="text-slate-600">Click or drag to upload HTML file</p>
            <input type="file" id="htmlFile" accept=".html,.htm" class="hidden">
          </div>
          <p id="htmlFileName" class="text-sm text-slate-500 mt-2 hidden"></p>
        </div>

        <div>
          <label class="block text-sm font-medium text-slate-700 mb-2">Images (optional)</label>
          <div id="imgDropZone" class="border-2 border-dashed border-slate-300 rounded-xl p-6 text-center hover:border-blue-400 transition-colors cursor-pointer">
            <svg class="w-10 h-10 mx-auto text-slate-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
            <p class="text-slate-600">Click or drag to upload images</p>
            <p class="text-sm text-slate-400">Multiple files allowed - JPG, PNG, WebP</p>
            <input type="file" id="postImages" accept=".jpg,.jpeg,.png,.webp" multiple class="hidden">
          </div>
          <div id="imagePreviewGrid" class="grid grid-cols-4 gap-3 mt-4 hidden"></div>
        </div>

        <button type="submit" id="postSubmit" class="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-slate-300 disabled:cursor-not-allowed text-white font-medium py-3 px-4 rounded-lg transition-colors flex items-center justify-center">
          <span id="postBtnText">Upload Post</span>
          <svg id="postSpinner" class="hidden animate-spin ml-2 h-5 w-5" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
        </button>
      </form>
    </div>
  </main>

  <script>
    // ===== Toast System =====
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      const content = document.getElementById('toastContent');
      const icon = document.getElementById('toastIcon');
      const msg = document.getElementById('toastMessage');

      msg.textContent = message;

      if (type === 'success') {
        content.className = 'px-6 py-4 rounded-xl shadow-lg flex items-center gap-3 min-w-[300px] bg-emerald-50 border border-emerald-200';
        icon.textContent = '\u2713';
        icon.className = 'text-xl text-emerald-600 font-bold';
      } else {
        content.className = 'px-6 py-4 rounded-xl shadow-lg flex items-center gap-3 min-w-[300px] bg-red-50 border border-red-200';
        icon.textContent = '\u2717';
        icon.className = 'text-xl text-red-600 font-bold';
      }

      toast.style.transform = 'translateX(0)';
      setTimeout(() => {
        toast.style.transform = 'translateX(120%)';
      }, 3000);
    }

    // ===== Type Selector =====
    const thumbRadio = document.getElementById('thumbRadio');
    const postRadio = document.getElementById('postRadio');
    const thumbCard = document.getElementById('thumbCard');
    const postCard = document.getElementById('postCard');
    const thumbnailForm = document.getElementById('thumbnailForm');
    const postForm = document.getElementById('postForm');

    function updateTypeUI() {
      if (thumbRadio.checked) {
        thumbCard.className = 'border-2 rounded-xl p-4 text-center transition-all border-blue-600 bg-blue-50';
        postCard.className = 'border-2 rounded-xl p-4 text-center transition-all border-slate-200';
        thumbCard.querySelector('svg').classList.replace('text-slate-400', 'text-blue-600');
        postCard.querySelector('svg').classList.replace('text-blue-600', 'text-slate-400');
        thumbnailForm.classList.remove('hidden');
        postForm.classList.add('hidden');
      } else {
        postCard.className = 'border-2 rounded-xl p-4 text-center transition-all border-blue-600 bg-blue-50';
        thumbCard.className = 'border-2 rounded-xl p-4 text-center transition-all border-slate-200';
        postCard.querySelector('svg').classList.replace('text-slate-400', 'text-blue-600');
        thumbCard.querySelector('svg').classList.replace('text-blue-600', 'text-slate-400');
        postForm.classList.remove('hidden');
        thumbnailForm.classList.add('hidden');
      }
    }

    thumbRadio.addEventListener('change', updateTypeUI);
    postRadio.addEventListener('change', updateTypeUI);

    // ===== Drag & Drop + File Select Helpers =====
    function setupDropZone(zoneId, inputId, onFiles) {
      const zone = document.getElementById(zoneId);
      const input = document.getElementById(inputId);

      zone.addEventListener('click', () => input.click());

      zone.addEventListener('dragover', (e) => {
        e.preventDefault();
        zone.classList.add('border-blue-400', 'bg-blue-50');
      });

      zone.addEventListener('dragleave', () => {
        zone.classList.remove('border-blue-400', 'bg-blue-50');
      });

      zone.addEventListener('drop', (e) => {
        e.preventDefault();
        zone.classList.remove('border-blue-400', 'bg-blue-50');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          input.files = files;
          onFiles(files);
        }
      });

      input.addEventListener('change', () => {
        if (input.files.length > 0) onFiles(input.files);
      });
    }

    // ===== Thumbnail Upload =====
    const thumbFile = document.getElementById('thumbFile');
    const thumbPreview = document.getElementById('thumbPreview');
    const thumbPreviewImg = document.getElementById('thumbPreviewImg');
    const thumbPreviewName = document.getElementById('thumbPreviewName');

    setupDropZone('thumbDropZone', 'thumbFile', (files) => {
      const file = files[0];
      const reader = new FileReader();
      reader.onload = (e) => {
        thumbPreviewImg.src = e.target.result;
        thumbPreviewName.textContent = `${file.name} (${formatSize(file.size)})`;
        thumbPreview.classList.remove('hidden');
      };
      reader.readAsDataURL(file);
    });

    document.getElementById('thumbClear').addEventListener('click', () => {
      thumbFile.value = '';
      thumbPreview.classList.add('hidden');
    });

    document.getElementById('thumbForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!thumbFile.files[0]) {
        showToast('Please select an image file', 'error');
        return;
      }

      const btn = document.getElementById('thumbSubmit');
      const btnText = document.getElementById('thumbBtnText');
      const spinner = document.getElementById('thumbSpinner');

      btn.disabled = true;
      btnText.textContent = 'Uploading...';
      spinner.classList.remove('hidden');

      try {
        const formData = new FormData();
        formData.append('thumbnail', thumbFile.files[0]);

        const response = await fetch('/api/upload/thumbnail', {
          method: 'POST',
          body: formData
        });

        const data = await response.json();

        if (data.success) {
          showToast('Thumbnail uploaded successfully!');
          thumbFile.value = '';
          thumbPreview.classList.add('hidden');
        } else {
          showToast(data.error || 'Upload failed', 'error');
        }
      } catch (err) {
        showToast('Connection error. Please try again.', 'error');
      } finally {
        btn.disabled = false;
        btnText.textContent = 'Upload Thumbnail';
        spinner.classList.add('hidden');
      }
    });

    // ===== Blog Post Upload =====
    const postTitle = document.getElementById('postTitle');
    const slugPreview = document.getElementById('slugPreview');
    const htmlFile = document.getElementById('htmlFile');
    const htmlFileName = document.getElementById('htmlFileName');
    const postImages = document.getElementById('postImages');
    const imagePreviewGrid = document.getElementById('imagePreviewGrid');

    // Slug preview
    postTitle.addEventListener('input', () => {
      const slug = postTitle.value
        .toLowerCase()
        .replace(/[^a-z0-9\s-]/g, '')
        .replace(/\s+/g, '-')
        .replace(/-+/g, '-')
        .replace(/^-+|-+$/g, '');
      slugPreview.textContent = slug ? `Slug: ${slug}` : '';
    });

    // HTML file
    setupDropZone('htmlDropZone', 'htmlFile', (files) => {
      htmlFileName.textContent = `Selected: ${files[0].name}`;
      htmlFileName.classList.remove('hidden');
    });

    // Post images
    setupDropZone('imgDropZone', 'postImages', (files) => {
      imagePreviewGrid.innerHTML = '';
      imagePreviewGrid.classList.remove('hidden');

      Array.from(files).forEach(file => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const div = document.createElement('div');
          div.className = 'relative aspect-square rounded-lg overflow-hidden bg-slate-100';
          div.innerHTML = `
            <img src="${e.target.result}" class="w-full h-full object-cover" alt="${file.name}">
            <div class="absolute bottom-0 left-0 right-0 bg-black/50 text-white text-xs p-1 truncate">${file.name}</div>
          `;
          imagePreviewGrid.appendChild(div);
        };
        reader.readAsDataURL(file);
      });
    });

    document.getElementById('blogForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!postTitle.value.trim()) {
        showToast('Please enter a post title', 'error');
        return;
      }
      if (!htmlFile.files[0]) {
        showToast('Please select an HTML file', 'error');
        return;
      }

      const btn = document.getElementById('postSubmit');
      const btnText = document.getElementById('postBtnText');
      const spinner = document.getElementById('postSpinner');

      btn.disabled = true;
      btnText.textContent = 'Uploading...';
      spinner.classList.remove('hidden');

      try {
        const formData = new FormData();
        formData.append('title', postTitle.value.trim());
        formData.append('htmlFile', htmlFile.files[0]);

        if (postImages.files.length > 0) {
          Array.from(postImages.files).forEach(file => {
            formData.append('images', file);
          });
        }

        const response = await fetch('/api/upload/post', {
          method: 'POST',
          body: formData
        });

        const data = await response.json();

        if (data.success) {
          showToast('Blog post uploaded successfully!');
          postTitle.value = '';
          slugPreview.textContent = '';
          htmlFile.value = '';
          htmlFileName.classList.add('hidden');
          postImages.value = '';
          imagePreviewGrid.innerHTML = '';
          imagePreviewGrid.classList.add('hidden');
        } else {
          showToast(data.error || 'Upload failed', 'error');
        }
      } catch (err) {
        showToast('Connection error. Please try again.', 'error');
      } finally {
        btn.disabled = false;
        btnText.textContent = 'Upload Post';
        spinner.classList.add('hidden');
      }
    });

    // ===== Utility =====
    function formatSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }
  </script>
</body>
</html>
